---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import R1Card from "@/components/ui/R1Card.astro";
import R1Header from "@/components/ui/R1Header.astro";
import R1Banner from "@/components/ui/R1Banner.astro";
import FlashStatus from "@/components/flash/FlashStatus.astro";
import FlashProgress from "@/components/flash/FlashProgress.astro";
import FlashLog from "@/components/flash/FlashLog.astro";

// Import for client-side script
const usesMTKUnlock = true;
---

<Layout title="R1 Flash Utility - Boondit">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-24 relative">
    <Section title="R1 Flash Utility" description="Flash Rabbit R1 stock firmware directly from your browser">
      <div class="max-w-7xl mx-auto relative">
        <R1Banner type="error" className="max-w-2xl !mt-0 mb-12">
          Proceed at your own risk: Flashing can erase data or brick your device. <strong>Wipe is always enabled.</strong>
        </R1Banner>

        <!-- Mobile Tabs (Visible only on small screens) -->
        <div class="flex md:hidden mb-6 bg-card/40 border border-border/50 rounded-xl p-1 gap-1">
          <button id="tab-controls" class="flex-1 py-2 text-[10px] font-mono uppercase tracking-widest rounded-lg bg-[hsl(var(--color-pink))] text-white">Controls</button>
          <button id="tab-status" class="flex-1 py-2 text-[10px] font-mono uppercase tracking-widest rounded-lg text-muted-foreground">Status</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-8 mb-8 items-start">
          
          <!-- Main Controls Column -->
          <div id="col-controls" class="md:col-span-8 space-y-8 block">
            
            <!-- Auto Flash -->
            <R1Card title="Auto_Flash" accent="pink">
              <p class="text-muted-foreground text-xs font-mono mb-6 uppercase tracking-wide leading-relaxed">
                Recommended: Automated workflow for BROM power-on, firmware fetch, and deployment.
              </p>
              <button
                id="autoFlash"
                class="w-full py-5 bg-[hsl(var(--color-pink))] hover:opacity-90 text-white rounded-xl font-mono text-sm font-bold tracking-[0.2em] transition-all shadow-lg shadow-[hsl(var(--color-pink))]/20 uppercase relative overflow-hidden group/btn"
              >
                <div class="absolute top-0 left-0 w-full h-1 flex opacity-50 group-hover/btn:opacity-100 transition-opacity">
                  <div class="flex-1 bg-white/20"></div>
                  <div class="flex-1 bg-[hsl(var(--color-purple))]"></div>
                  <div class="flex-1 bg-[hsl(var(--color-gray))]"></div>
                </div>
                START_AUTO_FLASH
              </button>
            </R1Card>

            <div class="relative py-2 flex items-center">
              <div class="flex-grow border-t border-border/30"></div>
              <span class="flex-shrink mx-4 text-[9px] font-mono text-muted-foreground uppercase tracking-[0.3em]">Manual_Mode</span>
              <div class="flex-grow border-t border-border/30"></div>
            </div>

            <!-- Manual Steps -->
            <R1Card title="Manual_Steps" accent="purple">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-3 rounded-xl bg-background/50 border border-border/40">
                  <label class="block text-[9px] font-mono text-muted-foreground uppercase mb-2">Step_00 // BROM</label>
                  <button id="enterFastboot" class="w-full py-2 bg-secondary/80 hover:bg-secondary text-secondary-foreground rounded-lg font-mono text-[10px] uppercase tracking-wider border border-border/50 transition-all">
                    ENTER_FASTBOOT
                  </button>
                </div>
                <div class="p-3 rounded-xl bg-background/50 border border-border/40">
                  <label class="block text-[9px] font-mono text-muted-foreground uppercase mb-2">Step_01 // BOOTLOADER</label>
                  <button id="connectBootloader" class="w-full py-2 bg-secondary/80 hover:bg-secondary text-secondary-foreground rounded-lg font-mono text-[10px] uppercase tracking-wider border border-border/50 transition-all">
                    SELECT_DEVICE
                  </button>
                </div>
                <div class="p-3 rounded-xl bg-background/50 border border-border/40">
                  <label class="block text-[9px] font-mono text-muted-foreground uppercase mb-2">Step_02 // REBOOT</label>
                  <button id="rebootFastbootd" disabled class="w-full py-2 bg-secondary/80 hover:bg-secondary text-secondary-foreground rounded-lg font-mono text-[10px] uppercase tracking-wider border border-border/50 transition-all disabled:opacity-30">
                    TO_FASTBOOTD
                  </button>
                </div>
                <div class="p-3 rounded-xl bg-background/50 border border-border/40">
                  <label class="block text-[9px] font-mono text-muted-foreground uppercase mb-2">Step_03 // CONNECT</label>
                  <button id="connectFastbootd" disabled class="w-full py-2 bg-secondary/80 hover:bg-secondary text-secondary-foreground rounded-lg font-mono text-[10px] uppercase tracking-wider border border-border/50 transition-all disabled:opacity-30">
                    CONNECT_FASTBOOTD
                  </button>
                </div>
              </div>

              <div class="mt-6 pt-6 border-t border-border/30">
                <button id="flashStock" disabled class="w-full py-4 bg-[hsl(var(--color-pink))] hover:bg-[hsl(var(--color-pink))]/90 text-white rounded-xl font-mono text-xs font-bold tracking-[0.2em] transition-all shadow-lg shadow-[hsl(var(--color-pink))]/20 uppercase disabled:opacity-30">
                  FLASH_STOCK_OS
                </button>
              </div>
            </R1Card>

            <!-- MTK Bootloader Unlock (r1_escape method) -->
            <R1Card title="MTK_Unlock" accent="purple">
              <p class="text-muted-foreground text-xs font-mono mb-4 uppercase tracking-wide leading-relaxed">
                Unlock bootloader via WebUSB using the r1_escape method: kamakiri2 exploit ‚Üí FRP modification ‚Üí fastboot unlock.
              </p>
              
              <div class="bg-card/50 border border-purple-500/20 rounded-lg p-4 mb-4 text-xs font-mono space-y-3">
                <div>
                  <p class="font-bold mb-2 text-purple-400">1. Enter BROM Mode:</p>
                  <ol class="list-decimal list-inside text-muted-foreground space-y-1">
                    <li>Power off R1 completely (hold power ~10 seconds)</li>
                    <li>Connect USB cable to computer <strong>while device is off</strong></li>
                    <li>Hold power button for 3-5 seconds ‚Äî do not let go yet</li>
                    <li>"MT65xx Preloader" appears in the WebUSB picker</li>
                  </ol>
                </div>
                <div>
                  <p class="font-bold mb-2 text-purple-400">2. What This Does:</p>
                  <ol class="list-decimal list-inside text-muted-foreground space-y-1">
                    <li>Kamakiri2 exploit bypasses BROM security (CDC overflow)</li>
                    <li>Uploads Download Agent for flash access</li>
                    <li>Reads FRP partition, sets unlock flag byte</li>
                    <li>Reboots to fastboot ‚Äî then click CONNECT_BOOTLOADER above</li>
                  </ol>
                </div>
                <div class="pt-2 border-t border-purple-500/10">
                  <p class="text-yellow-400 font-bold">‚ö†Ô∏è REQUIREMENTS:</p>
                  <ul class="list-disc list-inside text-muted-foreground space-y-1">
                    <li>Chrome or Edge 61+ (WebUSB required)</li>
                    <li>Do NOT disconnect USB during the process</li>
                    <li><strong>macOS</strong>: Run <code class="bg-card px-1 rounded">sudo kextunload -b com.apple.driver.usb.cdc.acm</code> first</li>
                    <li><strong>Linux</strong>: Create udev rules for MediaTek (0e8d)</li>
                  </ul>
                </div>
              </div>
              
              <button 
                id="mtkUnlock" 
                class="w-full py-4 bg-[hsl(var(--color-purple))] hover:opacity-90 text-white rounded-xl font-mono text-sm font-bold tracking-[0.2em] transition-all shadow-lg shadow-[hsl(var(--color-purple))]/20 uppercase relative overflow-hidden group/btn disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <div class="absolute top-0 left-0 w-full h-1 flex opacity-50 group-hover/btn:opacity-100 transition-opacity">
                  <div class="flex-1 bg-white/20"></div>
                  <div class="flex-1 bg-[hsl(var(--color-purple))]"></div>
                  <div class="flex-1 bg-[hsl(var(--color-gray))]"></div>
                </div>
                UNLOCK_BOOTLOADER
              </button>
            </R1Card>
          </div>

          <!-- Status/Sidebar Column -->
          <div id="col-status" class="md:col-span-4 space-y-6 hidden md:block">
            <FlashStatus />
            <FlashProgress />
            <FlashLog />
          </div>
        </div>
      </div>
    </Section>
  </div>

  <!-- Auto-Flash Modal -->
  <div id="autoFlashModal" class="fixed inset-0 z-[10000] bg-black/95 backdrop-blur-md hidden items-center justify-center p-4">
    <div class="relative w-full max-w-lg bg-card border border-[hsl(var(--color-pink))]/30 rounded-2xl shadow-2xl overflow-hidden">
      <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-[hsl(var(--color-pink))]/50 rounded-tl-2xl"></div>
      
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modalStepTitle" class="text-xl font-bold font-mono uppercase tracking-wider text-white">Auto_Flash</h2>
          <div class="text-[10px] font-mono text-muted-foreground uppercase tracking-widest">
            Step <span id="modalCurrentStep">1</span> / <span id="modalTotalSteps">4</span>
          </div>
        </div>

        <div class="min-h-[100px] mb-8">
          <p id="modalInstruction" class="text-muted-foreground font-mono text-xs uppercase leading-relaxed">Preparing auto-flash sequence...</p>
          
          <div id="modalProgress" class="hidden mt-6 space-y-3">
            <div class="h-1 w-full bg-secondary/30 rounded-full overflow-hidden">
              <div id="modalProgressBar" class="h-full w-0 bg-[hsl(var(--color-pink))] transition-all"></div>
            </div>
            <p id="modalProgressText" class="text-[9px] font-mono text-muted-foreground text-center uppercase tracking-widest">0%</p>
          </div>
        </div>

        <div class="flex gap-4">
          <button id="modalContinue" class="flex-1 py-3 bg-[hsl(var(--color-pink))] hover:bg-[hsl(var(--color-pink))]/90 text-white rounded-xl font-mono text-[10px] font-bold uppercase tracking-widest transition-all">Continue</button>
          <button id="modalCancel" class="flex-1 py-3 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-xl font-mono text-[10px] font-bold uppercase tracking-widest transition-all border border-border/50">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--color-pink) / 0.3); border-radius: 10px; }
</style>

<script type="module">
  import { FastbootDevice, USER_ACTION_MAP, setDebugLevel } from "https://cdn.jsdelivr.net/npm/android-fastboot@1.1.3/dist/fastboot.mjs";
  import { unlockBootloaderWebUSB } from "../lib/flash/mtk-unlock.js";

  // Tab Logic for Mobile
  const tabControls = document.getElementById('tab-controls');
  const tabStatus = document.getElementById('tab-status');
  const colControls = document.getElementById('col-controls');
  const colStatus = document.getElementById('col-status');

  if (tabControls && tabStatus && colControls && colStatus) {
    tabControls.addEventListener('click', () => {
      colControls.classList.remove('hidden');
      colStatus.classList.add('hidden');
      tabControls.classList.add('bg-[hsl(var(--color-pink))]', 'text-white');
      tabControls.classList.remove('text-muted-foreground');
      tabStatus.classList.remove('bg-[hsl(var(--color-pink))]', 'text-white');
      tabStatus.classList.add('text-muted-foreground');
    });
    tabStatus.addEventListener('click', () => {
      colControls.classList.add('hidden');
      colStatus.classList.remove('hidden');
      tabStatus.classList.add('bg-[hsl(var(--color-pink))]', 'text-white');
      tabStatus.classList.remove('text-muted-foreground');
      tabControls.classList.remove('bg-[hsl(var(--color-pink))]', 'text-white');
      tabControls.classList.add('text-muted-foreground');
    });
  }

  const bootloaderDevice = new FastbootDevice();
  const fastbootdDevice = new FastbootDevice();

  const state = {
    bootloaderConnected: false,
    fastbootdConnected: false,
    busy: false,
  };

  const elements = {
    autoFlash: document.getElementById("autoFlash"),
    enterFastboot: document.getElementById("enterFastboot"),
    connectBootloader: document.getElementById("connectBootloader"),
    rebootFastbootd: document.getElementById("rebootFastbootd"),
    connectFastbootd: document.getElementById("connectFastbootd"),
    flashStock: document.getElementById("flashStock"),
    mtkUnlock: document.getElementById("mtkUnlock"),
    webusbStatus: document.getElementById("webusbStatus"),
    webserialStatus: document.getElementById("webserialStatus"),
    bootloaderStatus: document.getElementById("bootloaderStatus"),
    fastbootdStatus: document.getElementById("fastbootdStatus"),
    statusLog: document.getElementById("statusLog"),
    downloadBar: document.getElementById("downloadBar"),
    downloadPct: document.getElementById("downloadPct"),
    flashBar: document.getElementById("flashBar"),
    flashPct: document.getElementById("flashPct"),
    flashAction: document.getElementById("flashAction"),
    flashItem: document.getElementById("flashItem"),
    autoFlashModal: document.getElementById("autoFlashModal"),
    modalStepTitle: document.getElementById("modalStepTitle"),
    modalCurrentStep: document.getElementById("modalCurrentStep"),
    modalTotalSteps: document.getElementById("modalTotalSteps"),
    modalInstruction: document.getElementById("modalInstruction"),
    modalProgress: document.getElementById("modalProgress"),
    modalProgressBar: document.getElementById("modalProgressBar"),
    modalProgressText: document.getElementById("modalProgressText"),
    modalContinue: document.getElementById("modalContinue"),
    modalCancel: document.getElementById("modalCancel"),
  };

  setDebugLevel(1);

  const supportsWebUsb = "usb" in navigator;
  const supportsWebSerial = "serial" in navigator;

  if (elements.webusbStatus) {
    elements.webusbStatus.textContent = supportsWebUsb ? "SUPPORTED" : "UNAVAILABLE";
    elements.webusbStatus.classList.toggle("is-ok", supportsWebUsb);
    elements.webusbStatus.classList.toggle("is-error", !supportsWebUsb);
  }

  if (elements.webserialStatus) {
    elements.webserialStatus.textContent = supportsWebSerial ? "SUPPORTED" : "UNAVAILABLE";
    elements.webserialStatus.classList.toggle("is-ok", supportsWebSerial);
    elements.webserialStatus.classList.toggle("is-error", !supportsWebSerial);
  }

  function logStatus(message, type = "info") {
    if (!elements.statusLog) return;
    const entry = document.createElement("div");
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    elements.statusLog.appendChild(entry);
    elements.statusLog.scrollTop = elements.statusLog.scrollHeight;
  }

  function setProgress(bar, label, value) {
    if (!bar || !label) return;
    const pct = Math.round(value * 100);
    bar.style.width = `${pct}%`;
    label.textContent = `${pct}%`;
  }

  function setConnectionStatus() {
    if (elements.bootloaderStatus) {
      elements.bootloaderStatus.textContent = state.bootloaderConnected ? "CONNECTED" : "NOT_CONNECTED";
      elements.bootloaderStatus.classList.toggle("is-ok", state.bootloaderConnected);
      elements.bootloaderStatus.classList.toggle("is-error", !state.bootloaderConnected);
    }
    if (elements.fastbootdStatus) {
      elements.fastbootdStatus.textContent = state.fastbootdConnected ? "CONNECTED" : "NOT_CONNECTED";
      elements.fastbootdStatus.classList.toggle("is-ok", state.fastbootdConnected);
      elements.fastbootdStatus.classList.toggle("is-error", !state.fastbootdConnected);
    }
  }

  function setButtonStates() {
    const { bootloaderConnected, fastbootdConnected, busy } = state;
    if (elements.autoFlash) elements.autoFlash.disabled = busy;
    if (elements.enterFastboot) elements.enterFastboot.disabled = busy;
    if (elements.connectBootloader) elements.connectBootloader.disabled = busy;
    if (elements.rebootFastbootd) elements.rebootFastbootd.disabled = busy || !bootloaderConnected;
    if (elements.connectFastbootd) elements.connectFastbootd.disabled = busy;
    if (elements.flashStock) elements.flashStock.disabled = busy || !fastbootdConnected;
    if (elements.mtkUnlock) elements.mtkUnlock.disabled = busy || !supportsWebUsb;
  }

  const FIRMWARE_MIRROR_BASE = "https://boondit.site/firmware";

  async function fetchLatestFirmware() {
    const response = await fetch("https://api.github.com/repos/rabbit-hmi-oss/firmware/releases/latest");
    if (!response.ok) throw new Error(`GitHub API error: ${response.status}`);
    const data = await response.json();
    const asset = (data.assets || []).find((entry) => entry.name && entry.name.toLowerCase().endsWith(".zip"));
    if (!asset) throw new Error("No firmware zip asset found.");
    return { name: asset.name, apiUrl: asset.url, url: asset.browser_download_url, mirrorUrl: `${FIRMWARE_MIRROR_BASE}/${asset.name}` };
  }

  async function downloadFirmware(asset, onProgress) {
    const versionMatch = asset.name.match(/_(v[\d.]+)\.zip$/);
    const version = versionMatch ? versionMatch[1] : null;
    const candidateUrls = [{ label: "Boondit Mirror", url: asset.mirrorUrl }, { label: "Boondit Proxy", url: version ? `${window.location.origin}/api/firmware/download?version=${version}` : null }, { label: "GitHub Direct", url: asset.url }].filter(c => c.url);

    let response;
    for (const candidate of candidateUrls) {
      try {
        logStatus(`Trying ${candidate.label}...`, "info");
        response = await fetch(candidate.url, { redirect: "follow", cache: "no-store" });
        if (response.ok) { logStatus(`Downloading from ${candidate.label}`, "success"); break; }
      } catch (error) { logStatus(`${candidate.label} failed: ${error.message}`, "error"); }
    }
    if (!response || !response.ok) throw new Error("Download failed from all sources.");

    const contentLength = Number(response.headers.get("content-length") || 0);
    const reader = response.body.getReader();
    const chunks = [];
    let received = 0;
    const startTime = Date.now();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      if (value) {
        chunks.push(value); received += value.length;
        if (onProgress && contentLength) {
          const elapsed = (Date.now() - startTime) / 1000;
          onProgress({ loaded: received, total: contentLength, percentage: received / contentLength, speed: received / elapsed });
        }
      }
    }
    return new File([new Blob(chunks)], asset.name, { type: "application/zip" });
  }

  async function enterFastbootFromBrom() {
    state.busy = true; setButtonStates(); logStatus("Requesting BROM device...");
    try {
      const port = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x0e8d, usbProductId: 0x2000 }] });
      await port.open({ baudRate: 115200 });
      const writer = port.writable.getWriter();
      await writer.write(new TextEncoder().encode("FASTBOOT"));
      await writer.close(); await port.close();
      logStatus("BROM command sent.", "success");
    } catch (error) { logStatus(`BROM failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); }
  }

  async function connectBootloader() {
    state.busy = true; setButtonStates(); logStatus("Connecting bootloader...");
    try { await bootloaderDevice.connect(); state.bootloaderConnected = true; logStatus("Connected.", "success"); }
    catch (error) { logStatus(`Failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); setConnectionStatus(); }
  }

  async function rebootToFastbootd() {
    state.busy = true; setButtonStates(); logStatus("Rebooting to fastbootd...");
    try { await bootloaderDevice.runCommand("reboot-fastboot"); state.bootloaderConnected = false; logStatus("Rebooted.", "success"); }
    catch (error) { logStatus(`Failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); setConnectionStatus(); }
  }

  async function connectFastbootd() {
    state.busy = true; setButtonStates(); logStatus("Connecting fastbootd...");
    try { await fastbootdDevice.connect(); state.fastbootdConnected = true; logStatus("Connected.", "success"); }
    catch (error) { logStatus(`Failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); setConnectionStatus(); }
  }

  async function flashStockOs() {
    state.busy = true; setButtonStates();
    setProgress(elements.flashBar, elements.flashPct, 0);
    setProgress(elements.downloadBar, elements.downloadPct, 0);
    try {
      const asset = await fetchLatestFirmware();
      const firmwareFile = await downloadFirmware(asset, (p) => {
        setProgress(elements.downloadBar, elements.downloadPct, p.percentage);
        if (elements.flashItem) elements.flashItem.textContent = `${(p.loaded/1024/1024).toFixed(1)}MB / ${(p.total/1024/1024).toFixed(1)}MB`;
      });
      await fastbootdDevice.flashFactoryZip(firmwareFile, true, async () => { await new Promise(r => setTimeout(r, 2500)); }, (action, item, progress) => {
        if (elements.flashAction) elements.flashAction.textContent = (USER_ACTION_MAP[action] || action || "FLASHING").toUpperCase();
        if (elements.flashItem) elements.flashItem.textContent = item || "";
        setProgress(elements.flashBar, elements.flashPct, progress || 0);
      });
      logStatus("Flash successful!", "success");
    } catch (error) { logStatus(`Flash failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); }
  }

  function showModal(step, title, ins, prog = false) {
    if (elements.modalCurrentStep) elements.modalCurrentStep.textContent = step;
    if (elements.modalStepTitle) elements.modalStepTitle.textContent = title.toUpperCase();
    if (elements.modalInstruction) elements.modalInstruction.textContent = ins.toUpperCase();
    if (elements.modalProgress) elements.modalProgress.classList.toggle("hidden", !prog);
    if (elements.autoFlashModal) { elements.autoFlashModal.classList.remove("hidden"); elements.autoFlashModal.classList.add("flex"); }
  }

  function hideModal() { if (elements.autoFlashModal) { elements.autoFlashModal.classList.add("hidden"); elements.autoFlashModal.classList.remove("flex"); } }

  async function autoFlash() {
    state.busy = true; setButtonStates();
    try {
      showModal(1, "BROM", "Connect powered-off R1. Click Continue.");
      await new Promise((res, rej) => { elements.modalContinue.onclick = res; elements.modalCancel.onclick = () => rej(new Error("Cancelled")); });
      try { await enterFastbootFromBrom(); await new Promise(r => setTimeout(r, 2000)); } catch(e){}
      
      showModal(2, "Bootloader", "Device should be in fastboot. Click Continue.");
      await new Promise((res, rej) => { elements.modalContinue.onclick = res; elements.modalCancel.onclick = () => rej(new Error("Cancelled")); });
      await connectBootloader();
      
      showModal(3, "Fastbootd", "Switching to fastbootd. Click Continue when ready.");
      await rebootToFastbootd(); await new Promise(r => setTimeout(r, 3000));
      await new Promise((res, rej) => { elements.modalContinue.onclick = res; elements.modalCancel.onclick = () => rej(new Error("Cancelled")); });
      await connectFastbootd();
      
      showModal(4, "Flash", "Flashing... do not disconnect.", true);
      await flashStockOs();
      hideModal(); logStatus("Completed!", "success");
    } catch (error) { hideModal(); logStatus(`Failed: ${error.message}`, "error"); }
    finally { state.busy = false; setButtonStates(); }
  }

  async function mtkUnlockHandler() {
    if (!supportsWebUsb) {
      logStatus("WebUSB not supported. Use Chrome/Edge 61+", "error");
      return;
    }

    state.busy = true;
    setButtonStates();
    logStatus("Starting MTK bootloader unlock (r1_escape method)...", "info");
    logStatus("Select 'MT65xx Preloader' in the WebUSB picker...", "info");
    
    try {
      const result = await unlockBootloaderWebUSB((progress) => {
        // Map progress phases to log types
        const type = progress.phase?.toLowerCase().includes("error") ? "error" 
                   : progress.phase?.toLowerCase().includes("done") ? "success" 
                   : "info";
        logStatus(`[${progress.phase}] ${progress.step}`, type);
      });
      
      if (result?.frpModified) {
        logStatus("FRP partition modified ‚Äî unlock flag set!", "success");
      }
      if (result?.rebootedToFastboot) {
        logStatus("Device rebooting to fastboot mode...", "success");
        logStatus("When device appears, click CONNECT_BOOTLOADER above", "info");
        logStatus("Then run: fastboot flashing unlock", "info");
      } else {
        logStatus("Bootloader unlock process completed!", "success");
      }
    } catch (error) {
      const errMsg = error instanceof Error ? error.message : String(error);
      
      // Multi-line error messages (e.g. driver-claim guidance) ‚Äî log each line
      const lines = errMsg.split("\n").filter(l => l.trim().length > 0);
      logStatus(`MTK unlock failed: ${lines[0]}`, "error");
      for (let i = 1; i < lines.length; i++) {
        logStatus(lines[i], "info");
      }
      
      // Provide helpful guidance for common errors
      if (errMsg.includes("No device selected") || errMsg.includes("NotFoundError")) {
        logStatus("üí° Make sure R1 is in BROM mode (powered off + USB + hold power)", "info");
      } else if (errMsg.includes("claim") || errMsg.includes("SecurityError")) {
        logStatus("üí° A kernel driver is holding the USB device", "info");
        logStatus("üí° macOS: sudo kextunload -b com.apple.driver.usb.cdc.acm", "info");
        logStatus("üí° Linux: echo -n 'DEVICE' | sudo tee /sys/bus/usb/drivers/cdc_acm/unbind", "info");
      } else if (errMsg.includes("handshake") || errMsg.includes("timeout")) {
        logStatus("üí° Try a different USB cable or port. Short cables work best.", "info");
      } else if (errMsg.includes("payload") || errMsg.includes("fetch")) {
        logStatus("üí° Payload files may be missing ‚Äî check browser console (F12)", "info");
      } else if (errMsg.includes("hw_code") || errMsg.includes("0x788")) {
        logStatus("üí° Device not recognized as Rabbit R1 (MT6771). Is this the right device?", "info");
      }
    } finally {
      state.busy = false;
      setButtonStates();
    }
  }

  elements.autoFlash?.addEventListener("click", autoFlash);
  elements.enterFastboot?.addEventListener("click", enterFastbootFromBrom);
  elements.connectBootloader?.addEventListener("click", connectBootloader);
  elements.rebootFastbootd?.addEventListener("click", rebootToFastbootd);
  elements.connectFastbootd?.addEventListener("click", connectFastbootd);
  elements.flashStock?.addEventListener("click", flashStockOs);
  elements.mtkUnlock?.addEventListener("click", mtkUnlockHandler);
  setButtonStates(); setConnectionStatus();
</script>
