---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
---

<Layout title="R1 Creation Gen - Boondit">
  <Section title="R1 QR Code Generator" className="min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
      <!-- Header -->
      <header class="text-center mb-6">
        <p class="text-gray-400 text-lg">Generate metadata for creations</p>
        <!-- Creation Store Banner -->
        <div class="mt-4 mb-3 mx-auto max-w-3xl">
          <div
            class="creation-store-banner"
            role="banner"
            aria-label="Announcement about Boondit Creation Store"
          >
            <div class="banner-content">
              <p class="banner-text">
                <span class="banner-prefix">❯</span>
                You can now publish your creation to the
                <a
                  href="https://creations.boondit.site/"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="banner-link"
                  aria-label="Visit Boondit Creation Store (opens in new tab)"
                >
                  Boondit Creation Store
                </a>
                <span class="banner-disclaimer">(not affiliated with Rabbit Inc)</span>
              </p>
            </div>
          </div>
        </div>

        <div class="mt-3 flex justify-center">
          <a
            href="https://buymeacoffee.com/boondit"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block"
          >
            <img
              src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=☕&slug=boondit&button_colour=FFDD00&font_colour=000000&font_family=Cookie&outline_colour=000000&coffee_colour=ffffff"
              alt="Buy Me A Coffee"
              style="height: 50px !important; width: 180px !important;"
            />
          </a>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Forms -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Creation Details Card -->
          <article class="card">
            <h2 class="card-title">Creation Details</h2>

            <div class="space-y-5">
              <div class="form-group">
                <label for="url" class="form-label">URL</label>
                <input
                  type="url"
                  id="url"
                  class="form-input"
                  placeholder="https://example.com"
                  value="https://barkle.chat"
                />
              </div>

              <div class="form-group">
                <label for="title" class="form-label">Title</label>
                <input
                  type="text"
                  id="title"
                  class="form-input"
                  placeholder="Enter title"
                  value="Barkle"
                />
              </div>

              <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <textarea
                  id="description"
                  rows="3"
                  class="form-input resize-none"
                  placeholder="Enter description">Social platform</textarea
                >
              </div>

              <div class="form-group">
                <label for="author" class="form-label">
                  Author <span class="text-gray-500 text-xs">(optional)</span>
                </label>
                <input
                  type="text"
                  id="author"
                  class="form-input"
                  placeholder="Enter author name"
                />
              </div>

              <div class="form-group">
                <label for="iconUrl" class="form-label">
                  Icon URL <span class="text-gray-500 text-xs">(optional)</span>
                </label>
                <input
                  type="url"
                  id="iconUrl"
                  class="form-input"
                  placeholder="https://example.com/icon.png"
                />
              </div>

              <div class="form-group">
                <label for="screenshotUrl" class="form-label">
                  Screenshot URL <span class="text-gray-500 text-xs"
                    >(optional)</span
                  >
                </label>
                <input
                  type="url"
                  id="screenshotUrl"
                  class="form-input"
                  placeholder="https://example.com/screenshot.png"
                />
                <button id="takeScreenshot" class="btn-secondary mt-3 w-full">
                  Generate Screenshot URL
                </button>
              </div>

              <div class="form-group">
                <label for="themeColor" class="form-label">Theme Color</label>
                <div class="flex gap-3">
                  <input
                    type="color"
                    id="themeColor"
                    class="color-picker"
                    value="#FE5000"
                  />
                  <input
                    type="text"
                    id="themeColorText"
                    class="form-input flex-1"
                    value="#FE5000"
                  />
                </div>
              </div>
            </div>
          </article>

          <!-- QR Styling Card -->
          <article class="card">
            <h2 class="card-title">QR Code Styling</h2>

            <div class="space-y-4">
              <div class="form-group">
                <label for="qrBgColor" class="form-label"
                  >Background Color</label
                >
                <div class="flex gap-3 items-center">
                  <input
                    type="color"
                    id="qrBgColor"
                    class="color-picker"
                    value="#FFFFFF"
                  />
                  <input
                    type="text"
                    id="qrBgColorText"
                    class="form-input flex-1"
                    value="#FFFFFF"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="form-group">
                  <label for="qrDotsStyle" class="form-label">Dots Style</label>
                  <select id="qrDotsStyle" class="form-select">
                    <option value="rounded">Rounded</option>
                    <option value="dots">Dots</option>
                    <option value="classy">Classy</option>
                    <option value="classy-rounded">Classy Rounded</option>
                    <option value="square">Square</option>
                    <option value="extra-rounded">Extra Rounded</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="qrCornerSquareStyle" class="form-label"
                    >Corner Squares</label
                  >
                  <select id="qrCornerSquareStyle" class="form-select">
                    <option value="dot">Dot</option>
                    <option value="square">Square</option>
                    <option value="extra-rounded">Extra Rounded</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="qrCornerDotStyle" class="form-label"
                    >Corner Dots</label
                  >
                  <select id="qrCornerDotStyle" class="form-select">
                    <option value="dot">Dot</option>
                    <option value="square">Square</option>
                  </select>
                </div>
              </div>
            </div>
          </article>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4">
            <button id="fetchMetadata" class="btn-primary flex-1">
              Fetch Metadata
            </button>
          </div>
        </div>

        <!-- Right Column: Previews -->
        <aside class="space-y-6">
          <!-- QR Preview Card -->
          <article class="card">
            <h3 class="card-subtitle">QR Code Preview</h3>
            <div class="preview-box" id="qrCodeWrapper">
              <p class="preview-placeholder">
                Generate a QR code to see preview
              </p>
            </div>
            <button id="downloadQR" class="btn-accent w-full mt-4" disabled>
              Download QR Code
            </button>
          </article>

          <!-- Screenshot Preview Card -->
          <article class="card">
            <h3 class="card-subtitle">Screenshot Preview</h3>
            <div class="preview-box-sm" id="screenshotWrapper">
              <p class="preview-placeholder">
                Enter a screenshot URL to see preview
              </p>
            </div>
          </article>

          <!-- JSON Preview Card -->
          <article class="card">
            <h3 class="card-subtitle">JSON Data</h3>
            <pre
              id="jsonPreview"
              class="json-preview">{`{
  "title": "Barkle",
  "url": "https://barkle.chat",
  "description": "Social platform",
  "iconUrl": "",
  "themeColor": "#FE5000",
  "author": "",
  "screenshotUrl": ""
}`}</pre>
          </article>
        </aside>
      </div>
    </div>
  </Section>
</Layout>

<script type="module">
  import {
    getElements,
    updateJsonPreview,
    updateScreenshotPreview,
    syncColorInputs,
  } from "/scripts/form-handlers.js";
  import { fetchMetadata } from "/scripts/metadata-fetcher.js";
  import {
    generateQRRealtime,
    downloadQR,
    takeScreenshot,
  } from "/scripts/qr-generator.js";

  let isInitialized = false;

  // Fetch Buy Me a Coffee supporter data
  async function fetchBMACData() {
    try {
      // Buy Me a Coffee widget endpoint (publicly accessible)
      const response = await fetch('https://developers.buymeacoffee.com/api/v1/supporters?page=1', {
        headers: {
          'Authorization': 'Bearer ' // Note: This would need actual API key in production
        }
      });
      
      // For now, we'll simulate the progress with a default value
      // In production, you would integrate with BMAC API properly
      const simulatedMonthlyAmount = 15; // Example: $15 raised so far
      const goalAmount = 30;
      const percentage = Math.min((simulatedMonthlyAmount / goalAmount) * 100, 100);
      
      updateProgressBar(simulatedMonthlyAmount, goalAmount, percentage);
    } catch (error) {
      console.log('Using default funding display');
      // Show a generic progress state
      const simulatedMonthlyAmount = 0;
      const goalAmount = 30;
      const percentage = 0;
      updateProgressBar(simulatedMonthlyAmount, goalAmount, percentage);
    }
  }

  function updateProgressBar(raised, goal, percentage) {
    const progressBar = document.getElementById('fundingProgressBar');
    const progressText = document.getElementById('fundingProgressText');
    const fundingAmount = document.getElementById('fundingAmount');
    
    if (progressBar && progressText && fundingAmount) {
      progressBar.style.width = percentage + '%';
      progressText.textContent = Math.round(percentage) + '%';
      fundingAmount.textContent = `$${raised} raised this month`;
    }
  }

  function initializeQRPage() {
    if (isInitialized) return;
    isInitialized = true;
    
    // Initialize funding progress bar
    fetchBMACData();
    
    const elements = getElements();

    // Debounce function for real-time updates
    let qrDebounceTimer;
    const debounceQRGeneration = (elements) => {
      clearTimeout(qrDebounceTimer);
      qrDebounceTimer = setTimeout(() => generateQRRealtime(elements), 300);
    };

    // Live JSON and screenshot previews + QR generation
    [
      elements.url,
      elements.title,
      elements.description,
      elements.iconUrl,
      elements.author,
      elements.screenshotUrl,
      elements.themeColor,
    ].forEach((el) => {
      if (el) {
        el.addEventListener("input", () => {
          updateJsonPreview(elements);
          debounceQRGeneration(elements);
        });
        el.addEventListener("change", () => {
          updateJsonPreview(elements);
          debounceQRGeneration(elements);
        });
      }
    });

    // QR styling fields
    [
      elements.qrBgColor,
      elements.qrDotsStyle,
      elements.qrCornerSquareStyle,
      elements.qrCornerDotStyle,
    ].forEach((el) => {
      if (el) {
        el.addEventListener("input", () => debounceQRGeneration(elements));
        el.addEventListener("change", () => debounceQRGeneration(elements));
      }
    });

    if (elements.screenshotUrl) {
      elements.screenshotUrl.addEventListener("input", () =>
        updateScreenshotPreview(elements),
      );
      elements.screenshotUrl.addEventListener("change", () =>
        updateScreenshotPreview(elements),
      );
    }

    // Color sync
    syncColorInputs(elements.themeColor, elements.themeColorText, () => {
      updateJsonPreview(elements);
      debounceQRGeneration(elements);
    });
    syncColorInputs(elements.qrBgColor, elements.qrBgColorText, () =>
      debounceQRGeneration(elements),
    );

    // Buttons
    if (elements.fetchMetadataBtn) {
      elements.fetchMetadataBtn.addEventListener("click", () =>
        fetchMetadata(elements),
      );
    }
    if (elements.takeScreenshotBtn) {
      elements.takeScreenshotBtn.addEventListener("click", () =>
        takeScreenshot(elements),
      );
    }
    if (elements.downloadQRBtn) {
      elements.downloadQRBtn.addEventListener("click", () =>
        downloadQR(elements),
      );
    }

    updateJsonPreview(elements);
    updateScreenshotPreview(elements);

    // Generate initial QR code if URL exists
    if (elements.url?.value) {
      generateQRRealtime(elements);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeQRPage);
  } else {
    initializeQRPage();
  }
</script>

<style>
  /* Funding Progress Bar */
  .funding-progress-container {
    background: hsl(240 15% 12%);
    border: 2px solid hsl(240 15% 24%);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
  }

  .funding-header {
    text-align: center;
    margin-bottom: 1rem;
  }

  .funding-message {
    font-size: 0.95rem;
    color: hsl(0 0% 98%);
    line-height: 1.6;
  }

  .funding-message strong {
    color: #FFDD00;
    font-weight: 700;
  }

  .progress-bar-wrapper {
    margin: 1rem 0;
  }

  .progress-bar-track {
    width: 100%;
    height: 2.5rem;
    background: hsl(240 15% 8%);
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid hsl(240 15% 20%);
    position: relative;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #FFDD00 0%, #FFA500 100%);
    border-radius: 0.5rem;
    transition: width 0.6s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 0%;
    position: relative;
  }

  .progress-text {
    font-size: 0.875rem;
    font-weight: 700;
    color: #000;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
  }

  .funding-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 0.75rem;
    font-size: 0.875rem;
  }

  .stat-item {
    color: hsl(0 0% 80%);
    font-weight: 600;
  }

  /* Creation Store Banner */
  .creation-store-banner {
    background: hsl(240 15% 12%);
    border: 2px solid hsl(240 15% 24%);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
  }

  .banner-content {
    text-align: center;
  }

  .banner-prefix {
    color: hsl(270 20% 55%);
    font-weight: 600;
    margin-right: 0.5rem;
  }

  .banner-text {
    font-size: 0.95rem;
    color: hsl(0 0% 98%);
    line-height: 1.6;
  }

  .banner-link {
    color: hsl(270 20% 55%);
    font-weight: 600;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s;
  }

  .banner-link:hover {
    color: hsl(270 30% 65%);
  }

  .banner-disclaimer {
    color: hsl(0 0% 63.9%);
    font-size: 0.85rem;
    font-style: italic;
    margin-left: 0.5rem;
  }

  /* Cards */
  .card {
    background: rgba(31, 41, 55, 0.6);
    backdrop-filter: blur(8px);
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid rgba(75, 85, 99, 0.5);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition:
      transform 0.2s,
      box-shadow 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
  }

  .card-title {
    font-size: 1.375rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(99, 102, 241, 0.3);
  }

  .card-subtitle {
    font-size: 1.125rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 1rem;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #e2e8f0;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
  }

  .form-input,
  .form-select {
    display: block;
    width: 100%;
    background: rgba(31, 41, 55, 0.8);
    color: #fff;
    border-radius: 0.5rem;
    border: 1px solid rgba(75, 85, 99, 0.6);
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s;
  }

  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .form-input:hover,
  .form-select:hover {
    border-color: rgba(99, 102, 241, 0.5);
  }

  .form-select {
    padding-right: 2.5rem;
    cursor: pointer;
  }

  .color-picker {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 0.5rem;
    border: 2px solid rgba(75, 85, 99, 0.6);
    cursor: pointer;
    transition: transform 0.2s;
  }

  .color-picker:hover {
    transform: scale(1.05);
  }

  /* Buttons */
  .btn-primary,
  .btn-success,
  .btn-secondary,
  .btn-accent {
    font-weight: 600;
    border-radius: 0.5rem;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: #fff;
  }
  .btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
  }
  .btn-secondary {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: #fff;
  }
  .btn-accent {
    background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
    color: #fff;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  .btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  .btn-secondary:hover {
    background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  .btn-accent:hover {
    background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .btn-primary:disabled,
  .btn-success:disabled,
  .btn-secondary:disabled,
  .btn-accent:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Preview Boxes */
  .preview-box,
  .preview-box-sm {
    border: 2px dashed rgba(107, 114, 128, 0.5);
    border-radius: 0.75rem;
    background: rgba(31, 41, 55, 0.5);
    padding: 2rem;
    min-height: 14rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 22rem;
    transition: border-color 0.2s;
  }

  .preview-box:hover,
  .preview-box-sm:hover {
    border-color: rgba(99, 102, 241, 0.5);
  }

  .preview-box-sm {
    padding: 1.25rem;
    min-height: 7rem;
  }

  .preview-placeholder {
    color: #94a3b8;
    text-align: center;
    font-size: 0.95rem;
    font-weight: 500;
  }

  /* JSON Preview */
  .json-preview {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(75, 85, 99, 0.5);
    color: #22d3ee;
    border-radius: 0.5rem;
    padding: 1.25rem;
    font-size: 0.875rem;
    overflow-x: auto;
    font-family: "Courier New", monospace;
    line-height: 1.6;
    scrollbar-width: thin;
    scrollbar-color: #4b5563 #1f2937;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .funding-progress-container {
      padding: 0.875rem 1rem;
    }

    .funding-message {
      font-size: 0.875rem;
    }

    .progress-bar-track {
      height: 2rem;
    }

    .progress-text {
      font-size: 0.75rem;
    }

    .funding-stats {
      font-size: 0.8rem;
      flex-direction: column;
      gap: 0.25rem;
      text-align: center;
    }

    .creation-store-banner {
      padding: 0.875rem 1rem;
    }

    .banner-text {
      font-size: 0.875rem;
    }

    .banner-disclaimer {
      display: block;
      margin-left: 0;
      margin-top: 0.25rem;
    }

    .card {
      padding: 1.5rem;
    }
  }
</style>
