---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import R1Card from "@/components/ui/R1Card.astro";
import R1Banner from "@/components/ui/R1Banner.astro";
---

<Layout title="R1 Component Generator - Boondit">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-24 relative">
    <Section title="R1 Generator" description="Generate metadata & deploy packages for creations">
      
      <div class="max-w-7xl mx-auto relative">
        <R1Banner type="info" className="max-w-xl !mt-0 mb-12">
          Publish your creation to the 
          <a href="https://creations.boondit.site/" target="_blank" class="font-bold text-foreground hover:text-[hsl(var(--color-purple))] transition-colors underline decoration-[hsl(var(--color-purple))]/50 underline-offset-4">Boondit Store</a>
        </R1Banner>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
          <!-- Form Section -->
          <div class="lg:col-span-7">
            <R1Card title="Metadata Details" accent="pink">
              <form id="creation-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Title -->
                  <div>
                    <label for="title" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                      <span>Plugin Name</span>
                      <span class="text-[hsl(var(--color-pink))]">Required</span>
                    </label>
                    <input type="text" id="title" name="title" required value="Barkle" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2.5 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none font-mono text-sm" placeholder="Barkle" />
                  </div>
                  
                  <!-- Theme Color -->
                  <div>
                    <label for="themeColor" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                      <span>Theme Color</span>
                      <span class="text-[hsl(var(--color-pink))]">Required</span>
                    </label>
                    <div class="flex gap-2">
                      <div class="relative w-10 h-10 rounded-lg overflow-hidden border border-border/60 shrink-0 shadow-sm cursor-pointer">
                        <input type="color" id="themeColorPicker" value="#fe5000" class="absolute -inset-2 w-14 h-14 cursor-pointer bg-transparent border-0" />
                      </div>
                      <input type="text" id="themeColor" name="themeColor" required value="#FE5000" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none uppercase font-mono text-sm" />
                    </div>
                  </div>
                </div>

                <!-- URL -->
                <div>
                  <label for="url" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                    <span>Website URL</span>
                    <span class="text-[hsl(var(--color-pink))]">Required</span>
                  </label>
                  <input type="url" id="url" name="url" required value="https://barkle.chat" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2.5 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none font-mono text-sm" placeholder="https://barkle.chat" />
                </div>

                <!-- Description -->
                <div>
                  <label for="description" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                    <span>Description</span>
                    <span class="text-[hsl(var(--color-pink))]">Required</span>
                  </label>
                  <textarea id="description" name="description" required rows="2" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2.5 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none resize-none font-mono text-xs" placeholder="Describe your creation...">A community plugin for Rabbit R1.</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="author" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                      <span>Author</span>
                      <span class="text-muted-foreground">Optional</span>
                    </label>
                    <input type="text" id="author" name="author" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none font-mono text-xs" placeholder="@username" />
                  </div>
                  <div>
                    <label for="iconUrl" class="flex justify-between text-[10px] font-bold mb-2 text-foreground font-mono uppercase tracking-widest">
                      <span>Icon URL</span>
                      <span class="text-muted-foreground">Optional</span>
                    </label>
                    <input type="url" id="iconUrl" name="iconUrl" class="w-full bg-background border border-border/60 rounded-xl px-4 py-2 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none font-mono text-xs" placeholder="https://..." />
                  </div>
                </div>

                <!-- Output Box -->
                <div class="mt-8 pt-6 border-t border-border/30">
                  <div class="flex justify-between items-center mb-3">
                    <label class="block text-[10px] font-mono font-bold text-muted-foreground uppercase tracking-[0.2em]">Generated Data</label>
                    <button type="button" id="copy-btn" class="text-[10px] px-3 py-1.5 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-md font-mono transition-colors border border-border/50 shadow-sm flex items-center gap-2 uppercase tracking-widest">
                      <span>Copy JSON</span>
                    </button>
                  </div>
                  <div class="relative bg-slate-950 border border-border/60 rounded-xl overflow-hidden group p-1">
                    <textarea id="json-output" readonly rows="6" class="w-full bg-transparent px-4 py-4 text-[hsl(var(--color-pink))] font-mono text-[10px] focus:outline-none resize-none custom-scrollbar" placeholder="JSON will appear here..."></textarea>
                  </div>
                </div>
              </form>
            </R1Card>
          </div>

          <!-- Preview & Actions -->
          <div class="lg:col-span-5 space-y-8">
            <R1Card title="Scan to Install" accent="purple">
              <div class="flex flex-col items-center justify-center p-6 bg-background/50 rounded-2xl border border-border/40 relative overflow-hidden mb-6" style="background-image: radial-gradient(circle at 2px 2px, rgba(150,150,150,0.05) 1px, transparent 0); background-size: 20px 20px;">
                <div id="qr-code" class="bg-white p-4 rounded-xl shadow-sm mb-4 flex items-center justify-center min-w-[200px] min-h-[200px] relative z-10 border border-border/20">
                  <p class="text-gray-400 text-[10px] font-mono p-4 text-center">Waiting for details<span class="animate-pulse">_</span></p>
                </div>
                <div class="qr-footer text-[10px] text-muted-foreground mt-2 text-center uppercase tracking-widest"> 
                  <span id="qr-watermark">UNTITLED | BOONDIT.SITE</span>
                </div>
                
                <div class="text-center w-full max-w-xs mt-4">
                  <p class="text-xs font-bold text-foreground mb-1 font-mono uppercase tracking-widest truncate" id="preview-title">UNTITLED</p>
                  <p class="text-[10px] text-muted-foreground font-mono truncate opacity-60" id="preview-url">waiting-for-url</p>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                 <button id="download-btn" class="py-2.5 bg-secondary/50 hover:bg-secondary text-foreground rounded-xl font-mono text-[10px] tracking-widest transition-all border border-border/50 uppercase disabled:opacity-30" disabled>
                    Save JSON
                  </button>
                  <button id="download-qr-btn" class="py-2.5 bg-secondary/50 hover:bg-secondary text-foreground rounded-xl font-mono text-[10px] tracking-widest transition-all border border-border/50 uppercase disabled:opacity-30" disabled>
                    Save Image
                  </button>
                  <button id="expand-qr-btn" class="py-2.5 bg-background hover:bg-secondary/30 text-foreground rounded-xl w-full border border-border/50 font-mono text-[10px] tracking-widest transition-all uppercase flex justify-center items-center gap-2 hidden">
                    Fullscreen
                  </button>
                  <div class="relative col-span-2">
                    <input type="file" id="import-file" accept=".json" class="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-10" />
                    <button type="button" class="py-2.5 bg-background/50 hover:bg-secondary/30 text-foreground rounded-xl w-full border border-border/50 font-mono text-[10px] tracking-widest transition-all uppercase flex justify-center items-center gap-2">
                      Import File
                    </button>
                  </div>
              </div>
            </R1Card>

            <R1Card title="Quick Guide" accent="gray" corners="none" className="opacity-80">
              <ul class="space-y-3 font-mono text-[10px] text-muted-foreground uppercase tracking-wider">
                <li class="flex gap-3"><span class="text-[hsl(var(--color-pink))]">01</span> Fill in the plugin details</li>
                <li class="flex gap-3"><span class="text-[hsl(var(--color-pink))]">02</span> Scan the QR with Rabbit R1 camera</li>
                <li class="flex gap-3"><span class="text-[hsl(var(--color-pink))]">03</span> Deploy and test your creation</li>
              </ul>
            </R1Card>
          </div>
        </div>
      </div>
    </Section>
  </div>

  <div id="qrModal" class="fixed inset-0 z-[10000] bg-black/95 backdrop-blur-md hidden items-center justify-center p-4">
      <div class="relative w-full max-w-2xl flex flex-col items-center">
          <button id="closeModalBtn" class="absolute -top-16 right-0 text-white hover:text-[hsl(var(--color-pink))] transition-colors p-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
          <div id="modalQrContainer" class="bg-white p-10 rounded-2xl shadow-2xl border-4 border-[hsl(var(--color-pink))]/20"></div>
          <p class="text-[hsl(var(--color-pink))] mt-8 text-center font-mono font-bold uppercase tracking-widest animate-pulse">Scan with Rabbit R1</p>
      </div>
  </div>
</Layout>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: hsl(var(--color-pink) / 0.3);
    border-radius: 10px;
  }
</style>

<script is:inline>
  let qrCode = null;

  function initGenerator() {
    const form = document.getElementById("creation-form");
    const jsonOutput = document.getElementById("json-output");
    const qrContainer = document.getElementById("qr-code");
    const downloadBtn = document.getElementById("download-btn");
    const downloadQrBtn = document.getElementById("download-qr-btn");
    const expandBtn = document.getElementById("expand-qr-btn");
    const importFile = document.getElementById("import-file");
    const copyBtn = document.getElementById("copy-btn");
    
    const previewTitle = document.getElementById("preview-title");
    const previewUrl = document.getElementById("preview-url");
    
    const themeColorText = document.getElementById("themeColor");
    const themeColorPicker = document.getElementById("themeColorPicker");

    const modal = document.getElementById('qrModal');
    const modalQrContainer = document.getElementById('modalQrContainer');
    const closeModalBtn = document.getElementById('closeModalBtn');

    if (typeof QRCodeStyling === 'undefined') {
      setTimeout(initGenerator, 200);
      return;
    }

    if (!form || !jsonOutput || !qrContainer) return;

    // Modal Logic
    const openModal = () => {
        if (!jsonOutput.value || !modal || !modalQrContainer) return;
        const themeColor = themeColorText.value || "#000000";
        
        modalQrContainer.innerHTML = '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        const modalQrCode = new QRCodeStyling({
            width: 500,
            height: 500,
            data: jsonOutput.value,
            dotsOptions: { color: themeColor, type: "rounded" },
            backgroundOptions: { color: "#ffffff" },
        });
        modalQrCode.append(modalQrContainer);
    };

    const closeModal = () => {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    };

    expandBtn?.addEventListener('click', openModal);
    closeModalBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal?.classList.contains('hidden')) closeModal();
    });

    themeColorPicker.addEventListener('input', (e) => {
      themeColorText.value = e.target.value.toUpperCase();
      generateJSON();
    });

    themeColorText.addEventListener('input', (e) => {
      let val = e.target.value;
      if (val.match(/^#[0-9a-fA-F]{6}$/)) {
        themeColorPicker.value = val;
      }
    });

    function sanitizeInput(value) {
      if (!value) return "";
      return value.replace(/[\n\r]/g, " ").replace(/"/g, '\\"');
    }

    function generateJSON() {
      const formData = new FormData(form);
      const title = sanitizeInput(formData.get("title"));
      const urlValue = sanitizeInput(formData.get("url"));
      const themeColor = sanitizeInput(formData.get("themeColor"));
      const description = sanitizeInput(formData.get("description"));
      
      const data = {
        title: title,
        url: urlValue,
        description: description,
        iconUrl: sanitizeInput(formData.get("iconUrl")),
        themeColor: themeColor,
        author: sanitizeInput(formData.get("author")),
        screenshotUrl: ""
      };

      const jsonStr = JSON.stringify(data, null, 2);
      jsonOutput.value = jsonStr;
      if (previewTitle) previewTitle.textContent = title || "UNTITLED";
      if (previewUrl) previewUrl.textContent = urlValue || "waiting-for-url";

      if (urlValue && title && themeColor && description) {
        downloadBtn.disabled = false;
        if (downloadQrBtn) downloadQrBtn.disabled = false;
        if (expandBtn) expandBtn.classList.remove('hidden');
        generateQR(jsonStr);
        const watermark = document.getElementById('qr-watermark');
        if (watermark) watermark.textContent = `${title.toUpperCase() || 'UNTITLED'} | BOONDIT.SITE`;
      } else {
        downloadBtn.disabled = true;
        if (downloadQrBtn) downloadQrBtn.disabled = true;
        if (expandBtn) expandBtn.classList.add('hidden');
        qrContainer.innerHTML = '<p class="text-muted-foreground text-[10px] font-mono p-4 text-center uppercase">Waiting for details<span class="animate-pulse">_</span></p>';
      }
    }

    let generatedDataUrl = null;
    async function buildWatermarkedQR(dataStr) {
      const themeColor = (document.getElementById('themeColor')?.value || '#000000').toUpperCase();
      const canvas = document.createElement('canvas');
      canvas.width = 340;
      canvas.height = 380;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (window.QRCodeStyling) {
        const tmp = new QRCodeStyling({
          width: 300,
          height: 300,
          data: dataStr,
          margin: 10,
          qrOptions: { errorCorrectionLevel: 'H' },
          dotsOptions: { color: themeColor, type: "rounded" },
          backgroundOptions: { color: '#ffffff' },
        });

        const blob = await tmp.getRawData('png');
        const img = new Image();
        img.src = URL.createObjectURL(blob);
        await new Promise(r => img.onload = r);
        ctx.drawImage(img, 20, 20, 300, 300);
        
        ctx.fillStyle = '#666666';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        const title = (document.getElementById('title')?.value || '').toUpperCase();
        ctx.fillText(title ? `${title} | BOONDIT.SITE` : 'BOONDIT.SITE', canvas.width / 2, 355);

        qrContainer.innerHTML = '';
        qrContainer.appendChild(canvas);
        generatedDataUrl = canvas.toDataURL('image/png');
      }
    }

    function generateQR(data) {
      buildWatermarkedQR(data);
    }

    form.addEventListener("input", generateJSON);
    copyBtn.addEventListener("click", () => {
      jsonOutput.select();
      document.execCommand("copy");
      const old = copyBtn.innerHTML;
      copyBtn.innerHTML = "<span>JSON Copied!</span>";
      setTimeout(() => copyBtn.innerHTML = old, 2000);
    });

    downloadBtn.addEventListener("click", () => {
      const blob = new Blob([jsonOutput.value], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "info.json"; a.click();
    });

    downloadQrBtn.addEventListener('click', () => {
      if (!generatedDataUrl) return;
      const a = document.createElement('a');
      a.href = generatedDataUrl;
      a.download = (document.getElementById('title')?.value || 'creation') + '-qr.png';
      a.click();
    });

    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          const map = { title: "title", description: "description", iconUrl: "iconUrl", themeColor: "themeColor", author: "author", url: "url" };
          for (const [k, v] of Object.entries(map)) {
            if (json[k] !== undefined) document.getElementById(v).value = json[k];
          }
          generateJSON();
        } catch (err) { alert("Invalid JSON"); }
      };
      reader.readAsText(file);
    });
    
    generateJSON();
  }

  document.addEventListener("DOMContentLoaded", initGenerator);
  document.addEventListener("astro:page-load", initGenerator);
</script>
