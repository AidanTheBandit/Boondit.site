---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
---

<Layout title="R1 Component Generator - Boondit">
  <div class="mt-24 md:mt-32 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-24 relative">
    <Section title="R1 QR Generator">
      
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
          <p class="text-muted-foreground text-lg font-medium">Generate metadata & deploy packages for creations</p>
          
          <!-- Creation Store Banner -->
          <div class="mt-8 mb-6 mx-auto max-w-3xl">
            <div class="bg-card/50 border border-primary/20 rounded-2xl p-4 shadow-sm flex items-center justify-center gap-3">
                <span class="text-primary font-bold">‚ùØ</span>
                <span class="text-muted-foreground font-medium">You can now publish your creation to the</span>
                <a
                  href="https://creations.boondit.site/"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="font-bold text-foreground hover:text-primary transition-colors underline decoration-primary/30 underline-offset-4 decoration-2"
                >
                  Boondit Creation Store
                </a>
            </div>
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Form Section -->
          <div class="bg-card/40 border border-border/50 rounded-3xl p-8 shadow-sm h-fit">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 border-b border-border/30 pb-4">
              <div class="w-4 h-4 rounded-sm bg-[hsl(var(--color-pink))]"></div>
              Metadata Setup
            </h2>
            <form id="creation-form" class="space-y-6">
              <div class="space-y-5">
                <div>
                  <label for="id" class="block text-sm font-semibold mb-2 text-foreground">Creation ID</label>
                  <input
                    type="text"
                    id="id"
                    name="id"
                    required
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                    placeholder="my-awesome-creation"
                  />
                </div>
                
                <div>
                  <label for="url" class="block text-sm font-semibold mb-2 text-foreground">Git Repository URL</label>
                  <input
                    type="url"
                    id="url"
                    name="url"
                    required
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                    placeholder="https://github.com/username/repo"
                  />
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="author" class="block text-sm font-semibold mb-2 text-foreground">Author Name</label>
                    <input
                      type="text"
                      id="author"
                      name="author"
                      required
                      class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                      placeholder="John Doe"
                    />
                  </div>
                  <div>
                    <label for="version" class="block text-sm font-semibold mb-2 text-foreground">Version</label>
                    <input
                      type="text"
                      id="version"
                      name="version"
                      required
                      class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                      placeholder="1.0.0"
                    />
                  </div>
                </div>

                <div>
                  <label for="name" class="block text-sm font-semibold mb-2 text-foreground">Display Name</label>
                  <input
                    type="text"
                    id="name"
                    name="name"
                    required
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                    placeholder="My Awesome Creation"
                  />
                </div>

                <div>
                  <label for="description" class="block text-sm font-semibold mb-2 text-foreground">Description</label>
                  <textarea
                    id="description"
                    name="description"
                    required
                    rows="3"
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none resize-none"
                    placeholder="A brief description of what this does"
                  ></textarea>
                </div>
              </div>

              <!-- Output Box -->
              <div class="mt-8">
                <div class="flex justify-between items-center mb-3">
                  <label class="block text-sm font-semibold text-foreground">Generated JSON</label>
                  <button
                    type="button"
                    id="copy-btn"
                    class="text-xs px-3 py-1.5 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-md font-medium transition-colors border border-border/50 shadow-sm"
                  >
                    Copy to Clipboard
                  </button>
                </div>
                <div class="relative bg-background border border-border/60 rounded-xl overflow-hidden group">
                  <textarea
                    id="json-output"
                    readonly
                    rows="10"
                    class="w-full bg-transparent px-4 py-4 text-primary font-mono text-sm focus:outline-none resize-none"
                    placeholder="JSON will appear here..."
                  ></textarea>
                </div>
              </div>
            </form>
          </div>

          <!-- Preview Section -->
          <div class="bg-card/40 border border-border/50 rounded-3xl p-8 shadow-sm flex flex-col h-full">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 border-b border-border/30 pb-4">
              <div class="w-4 h-4 rounded-sm bg-[hsl(var(--color-purple))]"></div>
              Scan to Deploy
            </h2>
            
            <div class="flex-grow flex flex-col items-center justify-center p-6 bg-background rounded-2xl border border-border/60 relative overflow-hidden">
              <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full blur-3xl"></div>
              <div class="absolute bottom-0 left-0 w-32 h-32 bg-accent/5 rounded-full blur-3xl"></div>
              
              <div id="qr-code" class="bg-white p-4 rounded-2xl shadow-sm mb-6 flex items-center justify-center min-w-[250px] min-h-[250px] relative z-10 border border-border/20">
                <p class="text-gray-400 text-sm py-12 px-6 text-center">Fill out the form to generate a deployment QR code.</p>
              </div>
              
              <div class="text-center w-full max-w-sm relative z-10">
                <p class="text-sm font-medium text-foreground mb-1" id="preview-name">New Creation</p>
                <p class="text-xs text-muted-foreground font-mono" id="preview-id">waiting-for-input</p>
              </div>
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
               <button
                  type="button"
                  id="download-btn"
                  class="flex-1 py-3 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-xl w-full font-bold transition-all shadow-sm flex justify-center items-center gap-2 border border-border/50"
                  disabled
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                  Download Info.json
                </button>
                <div class="relative flex-1">
                  <input
                    type="file"
                    id="import-file"
                    accept=".json"
                    class="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-10"
                  />
                  <button
                    type="button"
                    class="py-3 bg-background hover:bg-secondary/30 text-foreground rounded-xl w-full font-bold transition-all shadow-sm flex justify-center items-center gap-2 border border-border/50"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    Import info.json
                  </button>
                </div>
            </div>
          </div>
        </div>
      </div>
    </Section>
  </div>
</Layout>

<!-- Keep existing script intact -->
<script is:inline>
  let qrCode = null;

  function initGenerator() {
    const form = document.getElementById("creation-form");
    const jsonOutput = document.getElementById("json-output");
    const qrContainer = document.getElementById("qr-code");
    const downloadBtn = document.getElementById("download-btn");
    const importFile = document.getElementById("import-file");
    const copyBtn = document.getElementById("copy-btn");
    const previewName = document.getElementById("preview-name");
    const previewId = document.getElementById("preview-id");
    
    // Check if qrcode styling is loaded
    if (typeof QRCodeStyling === 'undefined') {
      setTimeout(initGenerator, 200);
      return;
    }

    if (!form || !jsonOutput || !qrContainer) return;

    function sanitizeInput(value) {
      if (!value) return "";
      return value.replace(/[\n\r]/g, " ").replace(/"/g, '\\"');
    }

    function generateJSON() {
      const formData = new FormData(form);
      const host = "boondit.site";

      const data = {
        name: sanitizeInput(formData.get("name")),
        creationId: sanitizeInput(formData.get("id")),
        version: sanitizeInput(formData.get("version")),
        description: sanitizeInput(formData.get("description")),
        author: sanitizeInput(formData.get("author")),
        url: sanitizeInput(formData.get("url")),
        host: host,
      };

      const jsonString = JSON.stringify(data, null, 2);
      jsonOutput.value = jsonString;

      // Update preview text
      if (previewName && previewId) {
        previewName.textContent = data.name || "New Creation";
        previewId.textContent = data.creationId || "waiting-for-input";
      }

      // We actually want the QR to encode the URL itself for the system to clone
      // Not the JSON info block.
      const urlValue = data.url;
      const isComplete =
        data.name &&
        data.creationId &&
        data.version &&
        data.description &&
        data.author &&
        data.url;

      if (urlValue && isComplete) {
        downloadBtn.disabled = false;
        downloadBtn.classList.remove("opacity-50", "cursor-not-allowed");
        generateQR(urlValue);
      } else {
        downloadBtn.disabled = true;
        downloadBtn.classList.add("opacity-50", "cursor-not-allowed");
        qrContainer.innerHTML =
          '<p class="text-gray-400 text-sm p-8 text-center text-balance max-w-[200px]">Fill out all fields to generate a deployment QR code.</p>';
        qrCode = null;
      }
    }

    function generateQR(data) {
      qrContainer.innerHTML = "";
      qrCode = new QRCodeStyling({
        width: 250,
        height: 250,
        type: "svg",
        data: data,
        image:
          "https://raw.githubusercontent.com/AidanTheBandit/Boondit.site/main/public/favicon.svg",
        dotsOptions: {
          color: "#000000",
          type: "rounded",
        },
        backgroundOptions: {
          color: "#ffffff",
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 10,
        },
      });
      qrCode.append(qrContainer);
    }

    // Event Listeners
    form.addEventListener("input", generateJSON);

    copyBtn.addEventListener("click", () => {
      jsonOutput.select();
      document.execCommand("copy");

      const originalText = copyBtn.innerText;
      copyBtn.innerText = "Copied!";
      copyBtn.classList.add("bg-green-500", "text-white", "border-green-600");
      setTimeout(() => {
        copyBtn.innerText = originalText;
        copyBtn.classList.remove("bg-green-500", "text-white", "border-green-600");
      }, 2000);
    });

    downloadBtn.addEventListener("click", () => {
      const text = jsonOutput.value;
      if (!text) return;

      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "info.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);

          // Map json fields to form inputs
          const fieldMap = {
            name: "name",
            creationId: "id",
            version: "version",
            description: "description",
            author: "author",
            url: "url",
          };

          for (const [jsonKey, formId] of Object.entries(fieldMap)) {
            if (json[jsonKey] !== undefined) {
              const input = document.getElementById(formId);
              if (input) input.value = json[jsonKey];
            }
          }

          generateJSON();

          // Reset file input
          importFile.value = "";
        } catch (error) {
          console.error("Error parsing JSON:", error);
          alert("Invalid info.json file");
        }
      };
      reader.readAsText(file);
    });
  }

  // Initialize on load and Astro navigation
  document.addEventListener("DOMContentLoaded", initGenerator);
  document.addEventListener("astro:page-load", initGenerator);
</script>
