---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
---

<Layout title="R1 Component Generator - Boondit">
  <div class="mt-24 md:mt-32 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-24 relative">
    <Section title="R1 Generator">
      
      <div class="max-w-7xl mx-auto relative">
        <!-- Header -->
        <header class="text-center mb-12">
          <p class="text-muted-foreground text-lg font-mono">Generate metadata & deploy packages for creations</p>
          
          <!-- Creation Store Banner -->
          <div class="mt-8 mx-auto max-w-3xl relative group">
            <div class="absolute -inset-[1px] bg-gradient-to-r from-[hsl(var(--color-pink))] via-[hsl(var(--color-purple))] to-[hsl(var(--color-gray))] rounded-2xl opacity-50 group-hover:opacity-100 transition-opacity blur-sm"></div>
            <div class="relative bg-card/80 backdrop-blur-sm border border-border/50 rounded-2xl p-4 shadow-sm flex items-center justify-center gap-3">
                <span class="text-[hsl(var(--color-pink))] font-mono font-bold">‚ùØ</span>
                <span class="text-muted-foreground font-mono text-sm uppercase tracking-wide">Publish your creation to the</span>
                <a
                  href="https://creations.boondit.site/"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="font-mono font-bold text-foreground hover:text-[hsl(var(--color-purple))] transition-colors underline decoration-[hsl(var(--color-purple))]/50 underline-offset-4 decoration-2"
                >
                  Boondit Store
                </a>
            </div>
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Form Section -->
          <div class="bg-card/40 border border-border/50 rounded-2xl p-8 shadow-sm h-fit relative">
            <!-- decorative corner bracket -->
            <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-[hsl(var(--color-pink))]/50 rounded-tl-2xl"></div>
            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-[hsl(var(--color-purple))]/50 rounded-br-2xl"></div>

            <h2 class="text-xl font-bold mb-6 flex items-center gap-3 border-b border-border/30 pb-4 font-mono uppercase tracking-wider">
              <div class="w-2 h-6 bg-[hsl(var(--color-pink))]"></div>
              Metadata Payload
            </h2>
            <form id="creation-form" class="space-y-6">
              <div class="space-y-5">
                <!-- Title (Required) -->
                <div>
                  <label for="title" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                    <span>TITLE</span>
                    <span class="text-[hsl(var(--color-pink))] text-xs tracking-widest">[REQ]</span>
                  </label>
                  <input
                    type="text"
                    id="title"
                    name="title"
                    required
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none"
                    placeholder="Barkle"
                  />
                </div>
                
                <!-- URL (Required) -->
                <div>
                  <label for="url" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                    <span>URL</span>
                    <span class="text-[hsl(var(--color-pink))] text-xs tracking-widest">[REQ]</span>
                  </label>
                  <input
                    type="url"
                    id="url"
                    name="url"
                    required
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none font-mono text-sm"
                    placeholder="https://barkle.chat"
                  />
                </div>

                <!-- Theme Color (Required) -->
                <div>
                  <label for="themeColor" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                    <span>THEME_COLOR</span>
                    <span class="text-[hsl(var(--color-pink))] text-xs tracking-widest">[REQ]</span>
                  </label>
                  <div class="flex gap-3">
                    <div class="relative w-12 h-12 rounded-xl overflow-hidden border border-border/60 shrink-0 shadow-sm cursor-pointer">
                      <input
                        type="color"
                        id="themeColorPicker"
                        value="#fe5000"
                        class="absolute -inset-2 w-16 h-16 cursor-pointer bg-transparent border-0"
                      />
                    </div>
                    <input
                      type="text"
                      id="themeColor"
                      name="themeColor"
                      required
                      value="#fe5000"
                      class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-pink))]/20 focus:border-[hsl(var(--color-pink))] transition-all outline-none uppercase font-mono"
                      placeholder="#fe5000"
                    />
                  </div>
                </div>

                <!-- Description (Optional) -->
                <div>
                  <label for="description" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                    <span>DESCRIPTION</span>
                    <span class="text-muted-foreground text-xs tracking-widest">[OPT]</span>
                  </label>
                  <textarea
                    id="description"
                    name="description"
                    rows="2"
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none resize-none"
                    placeholder="Social platform"
                  ></textarea>
                </div>

                <!-- Author & Icon URL -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="author" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                      <span>AUTHOR</span>
                      <span class="text-muted-foreground text-xs tracking-widest">[OPT]</span>
                    </label>
                    <input
                      type="text"
                      id="author"
                      name="author"
                      class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none font-mono text-sm"
                      placeholder="Username"
                    />
                  </div>
                  <div>
                    <label for="iconUrl" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                      <span>ICON_URL</span>
                      <span class="text-muted-foreground text-xs tracking-widest">[OPT]</span>
                    </label>
                    <input
                      type="url"
                      id="iconUrl"
                      name="iconUrl"
                      class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none font-mono text-sm"
                      placeholder="https://..."
                    />
                  </div>
                </div>

                <!-- Screenshot URL -->
                <div>
                  <label for="screenshotUrl" class="flex justify-between text-sm font-semibold mb-2 text-foreground font-mono">
                    <span>SCREENSHOT_URL</span>
                    <span class="text-muted-foreground text-xs tracking-widest">[OPT]</span>
                  </label>
                  <input
                    type="url"
                    id="screenshotUrl"
                    name="screenshotUrl"
                    class="w-full bg-background border border-border/60 rounded-xl px-4 py-3 text-foreground focus:ring-2 focus:ring-[hsl(var(--color-purple))]/20 focus:border-[hsl(var(--color-purple))] transition-all outline-none font-mono text-sm"
                    placeholder="https://..."
                  />
                </div>
              </div>

              <!-- Output Box -->
              <div class="mt-8 pt-6 border-t border-border/30">
                <div class="flex justify-between items-center mb-3">
                  <label class="block text-sm font-mono text-muted-foreground uppercase tracking-widest">OUTPUT.JSON</label>
                  <button
                    type="button"
                    id="copy-btn"
                    class="text-xs px-3 py-1.5 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-md font-mono transition-colors border border-border/50 shadow-sm flex items-center gap-2 uppercase tracking-wide"
                  >
                    <span>[ COPY ]</span>
                  </button>
                </div>
                <div class="relative bg-black/50 border border-border/60 rounded-xl overflow-hidden group p-1">
                  <!-- scanner line effect -->
                  <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[hsl(var(--color-pink))]/10 to-transparent opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-1000 animate-pulse"></div>
                  
                  <textarea
                    id="json-output"
                    readonly
                    rows="9"
                    class="w-full bg-transparent px-4 py-4 text-[hsl(var(--color-pink))] font-mono text-sm focus:outline-none resize-none custom-scrollbar"
                    placeholder="JSON will appear here..."
                  ></textarea>
                </div>
              </div>
            </form>
          </div>

          <!-- Preview Section -->
          <div class="bg-card/40 border border-border/50 rounded-2xl p-8 shadow-sm flex flex-col h-full relative">
            <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-[hsl(var(--color-purple))]/50 rounded-tr-2xl"></div>
            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-[hsl(var(--color-pink))]/50 rounded-bl-2xl"></div>

            <h2 class="text-xl font-bold mb-6 flex items-center gap-3 border-b border-border/30 pb-4 font-mono uppercase tracking-wider">
              <div class="w-2 h-6 bg-[hsl(var(--color-purple))]"></div>
              Scan To Deploy
            </h2>
            
            <div class="flex-grow flex flex-col items-center justify-center p-6 bg-background rounded-2xl border border-border/60 relative overflow-hidden" style="background-image: radial-gradient(circle at 2px 2px, rgba(150,150,150,0.1) 1px, transparent 0); background-size: 20px 20px;">
              <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full blur-3xl"></div>
              <div class="absolute bottom-0 left-0 w-32 h-32 bg-accent/5 rounded-full blur-3xl"></div>
              
              <div id="qr-code" class="bg-white p-4 rounded-xl shadow-sm mb-6 flex items-center justify-center min-w-[250px] min-h-[250px] relative z-10 border border-border/20">
                <p class="text-gray-400 text-sm font-mono p-4 text-center">AWAITING_INPUT<span class="animate-pulse">_</span></p>
              </div>
              <div class="qr-footer text-xs text-muted-foreground mt-2 text-center"> 
                <span id="qr-watermark">UNTITLED | boondit.site</span>
              </div>
              
              <div class="text-center w-full max-w-sm relative z-10">
                <p class="text-sm font-bold text-foreground mb-1 font-mono uppercase tracking-widest" id="preview-title">UNTITLED</p>
                <p class="text-xs text-muted-foreground font-mono truncate" id="preview-url">waiting-for-url</p>
              </div>
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
               <button
                  type="button"
                  id="download-btn"
                  class="flex-1 py-3 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-xl w-full font-mono text-sm tracking-wider transition-all shadow-sm flex justify-center items-center gap-2 border border-border/50 uppercase"
                  disabled
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                  DL_JSON
                </button>
                <button
                  type="button"
                  id="download-qr-btn"
                  class="flex-1 py-3 bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-xl w-full font-mono text-sm tracking-wider transition-all shadow-sm flex justify-center items-center gap-2 border border-border/50 uppercase"
                  disabled
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                  DL_QR
                </button>
                <div class="relative flex-1">
                  <input
                    type="file"
                    id="import-file"
                    accept=".json"
                    class="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-10"
                  />
                  <button
                    type="button"
                    class="py-3 bg-background hover:bg-secondary/30 text-foreground rounded-xl w-full border border-border/50 font-mono text-sm tracking-wider transition-all shadow-sm flex justify-center items-center gap-2 uppercase"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    IMPORT_JSON
                  </button>
                </div>
            </div>
          </div>
        </div>
      </div>
    </Section>
  </div>
</Layout>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: hsl(var(--color-pink) / 0.3);
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--color-pink) / 0.5);
  }
</style>

<script is:inline>
  let qrCode = null;

  function initGenerator() {
    const form = document.getElementById("creation-form");
    const jsonOutput = document.getElementById("json-output");
    const qrContainer = document.getElementById("qr-code");
    const downloadBtn = document.getElementById("download-btn");
    const downloadQrBtn = document.getElementById("download-qr-btn");
    const importFile = document.getElementById("import-file");
    const copyBtn = document.getElementById("copy-btn");
    
    const previewTitle = document.getElementById("preview-title");
    const previewUrl = document.getElementById("preview-url");
    
    const themeColorText = document.getElementById("themeColor");
    const themeColorPicker = document.getElementById("themeColorPicker");

    // Check if qrcode styling is loaded
    if (typeof QRCodeStyling === 'undefined') {
      setTimeout(initGenerator, 200);
      return;
    }

    if (!form || !jsonOutput || !qrContainer) return;

    // Sync color inputs
    themeColorPicker.addEventListener('input', (e) => {
      themeColorText.value = e.target.value.toUpperCase();
      generateJSON();
    });

    themeColorText.addEventListener('input', (e) => {
      let val = e.target.value;
      if (val.match(/^#[0-9a-fA-F]{6}$/)) {
        themeColorPicker.value = val;
      }
    });

    function sanitizeInput(value) {
      if (!value) return "";
      return value.replace(/[\n\r]/g, " ").replace(/"/g, '\\"');
    }

    function generateJSON() {
      const formData = new FormData(form);

      const title = sanitizeInput(formData.get("title"));
      const urlValue = sanitizeInput(formData.get("url"));
      const themeColor = sanitizeInput(formData.get("themeColor"));
      const description = sanitizeInput(formData.get("description"));
      const iconUrl = sanitizeInput(formData.get("iconUrl"));
      const author = sanitizeInput(formData.get("author"));
      const screenshotUrl = sanitizeInput(formData.get("screenshotUrl"));

      const data = {
        title: title,
        url: urlValue,
        description: description,
        iconUrl: iconUrl,
        themeColor: themeColor,
        author: author,
        screenshotUrl: screenshotUrl
      };

      const jsonString = JSON.stringify(data, null, 2);
      jsonOutput.value = jsonString;

      // Update preview text
      if (previewTitle && previewUrl) {
        previewTitle.textContent = title || "UNTITLED";
        previewUrl.textContent = urlValue || "waiting-for-url";
      }

      // We actually want the QR to encode the URL itself for the system to clone
      const isComplete = title && urlValue && themeColor;

      if (urlValue && isComplete) {
        downloadBtn.disabled = false;
        downloadBtn.classList.remove("opacity-50", "cursor-not-allowed");
        if (downloadQrBtn) {
          downloadQrBtn.disabled = false;
          downloadQrBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }
        
        // Update the corner bracket colors based on the themeColor
        const cardBorders = document.querySelectorAll('.bg-card\\/40 .absolute');
        if (cardBorders.length > 0 && themeColor.match(/^#[0-9A-Fa-f]{6}$/)) {
            // just a subtle UI interaction
        }

        generateQR(urlValue);
        // update watermark
        const watermark = document.getElementById('qr-watermark');
        if (watermark) watermark.textContent = `${title || 'UNTITLED'} | boondit.site`;
      } else {
        downloadBtn.disabled = true;
        downloadBtn.classList.add("opacity-50", "cursor-not-allowed");
        if (downloadQrBtn) {
          downloadQrBtn.disabled = true;
          downloadQrBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
        qrContainer.innerHTML =
          '<p class="text-muted-foreground text-sm font-mono p-4 text-center">AWAITING_INPUT<span class="animate-pulse">_</span></p>';
        qrCode = null;
      }
    }

    // wire up QR download - use a canvas-based watermarked export to match
    // the creations QR generator behavior from prior commits
    let generatedDataUrl = null;
    async function buildWatermarkedQR(data) {
      const themeColor = (document.getElementById('themeColor')?.value || '#FE5000').toUpperCase();

      // create subtle themed background similar to the creations generator
      function createThemedBackground(hexColor) {
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        const tintFactor = 0.95;
        const tintedR = Math.round(r + (255 - r) * tintFactor);
        const tintedG = Math.round(g + (255 - g) * tintFactor);
        const tintedB = Math.round(b + (255 - b) * tintFactor);
        return `rgb(${tintedR}, ${tintedG}, ${tintedB})`;
      }

      const bgColor = createThemedBackground(themeColor);

      // canvas size tuned to include watermark below QR
      const canvas = document.createElement('canvas');
      canvas.width = 340;
      canvas.height = 380;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // produce QR image data via QRCodeStyling if available, else fallback URL
      let qrImageSrc;
      if (window.QRCodeStyling) {
        const tmp = new QRCodeStyling({
          width: 300,
          height: 300,
          type: 'canvas',
          data: data,
          margin: 10,
          qrOptions: { errorCorrectionLevel: 'H' },
          dotsOptions: { color: '#000000', type: 'rounded' },
          backgroundOptions: { color: '#ffffff' },
        });

        qrImageSrc = await new Promise((resolve) => {
          tmp.getRawData('png').then((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        });
      } else {
        const fg = themeColor.replace('#', '');
        qrImageSrc = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data)}&color=${fg}`;
      }

      // draw QR image centered with padding
      await new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          ctx.drawImage(img, 20, 20, 300, 300);

          // watermark text
          ctx.fillStyle = '#666666';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          const title = (document.getElementById('title')?.value || '').trim();
          const watermarkText = title ? `${title} | boondit.site` : 'boondit.site';
          ctx.fillText(watermarkText, canvas.width / 2, 355);

          // replace preview
          qrContainer.innerHTML = '';
          qrContainer.appendChild(canvas);

          generatedDataUrl = canvas.toDataURL('image/png');
          resolve(true);
        };
        img.onerror = () => resolve(true);
        img.src = qrImageSrc;
      });
    }

    if (downloadQrBtn) {
      downloadQrBtn.addEventListener('click', async () => {
        // If we already have a rasterized QR, download it, otherwise build it first
        if (!generatedDataUrl) {
          // try to build from the present payload (URL encoded into QR)
          const data = (document.getElementById('url')?.value || '').trim();
          if (!data) return;
          await buildWatermarkedQR(data);
        }

        if (!generatedDataUrl) return;
        const a = document.createElement('a');
        a.href = generatedDataUrl;
        a.download = (document.getElementById('title')?.value || 'creation') + '-qr.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    function generateQR(data) {
      // Use the watermarked canvas generator so the preview matches the
      // creations QR generator from history (canvas + watermark)
      qrContainer.innerHTML = "";
      qrCode = null;
      // buildWatermarkedQR is defined later and hoisted; it will render into qrContainer
      buildWatermarkedQR(data);
    }

    // Event Listeners
    form.addEventListener("input", generateJSON);

    copyBtn.addEventListener("click", () => {
      jsonOutput.select();
      document.execCommand("copy");

      const originalText = copyBtn.innerHTML;
      copyBtn.innerHTML = "<span>[ COPIED! ]</span>";
      copyBtn.classList.add("bg-[hsl(var(--color-pink))]", "text-white");
      copyBtn.classList.remove("bg-secondary", "text-secondary-foreground");
      setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove("bg-[hsl(var(--color-pink))]", "text-white");
        copyBtn.classList.add("bg-secondary", "text-secondary-foreground");
      }, 2000);
    });

    downloadBtn.addEventListener("click", () => {
      const text = jsonOutput.value;
      if (!text) return;

      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "info.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);

          // Map json fields to form inputs
          const fieldMap = {
            title: "title",
            description: "description",
            iconUrl: "iconUrl",
            themeColor: "themeColor",
            author: "author",
            screenshotUrl: "screenshotUrl",
            url: "url",
          };

          for (const [jsonKey, formId] of Object.entries(fieldMap)) {
            if (json[jsonKey] !== undefined) {
              const input = document.getElementById(formId);
              if (input) {
                input.value = json[jsonKey];
                if (formId === 'themeColor') {
                  const picker = document.getElementById("themeColorPicker");
                  if (picker && json[jsonKey].match(/^#[0-9A-Fa-f]{6}$/)) {
                    picker.value = json[jsonKey];
                  }
                }
              }
            }
          }

          generateJSON();

          // Reset file input
          importFile.value = "";
        } catch (error) {
          console.error("Error parsing JSON:", error);
          alert("Invalid info.json file");
        }
      };
      reader.readAsText(file);
    });
    
    // Initial generation attempt on load
    generateJSON();
  }

  // Initialize on load and Astro navigation
  document.addEventListener("DOMContentLoaded", initGenerator);
  document.addEventListener("astro:page-load", initGenerator);
</script>
